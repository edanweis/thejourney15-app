<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>
			thejourney.aila.org.au
		</title>
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no, width=device-width'>
		<link href='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.css' rel='stylesheet' type="text/css">
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
		<link rel='stylesheet' href='mapbox.directions.css' type='text/css' />
		<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
		<link rel='stylesheet' href='style.css' type='text/css' />
		<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.4/leaflet.fullscreen.css' rel='stylesheet' />
		<script src='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.js' type="text/javascript"></script>
		<script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
		 <script src="https://hammerjs.github.io/dist/hammer.js"></script>
		 <meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:site" content="@TheJourney">
		<meta name="twitter:creator" content="@TheJourney">
		<meta name="twitter:title" content="The Journey 2015">
		<meta name="twitter:description" content="Interactive Landscape Tour Map">
		<meta name="twitter:image" content="http://thejourney.aila.org.au/wp-content/uploads/2015/09/The_Journey-Logo-Colour.png">

	</head>
	<body>
	
		<div class="navbar-fixed">
		<nav>
		  <ul id="slide-out" class="side-nav show-on-large">
		  	<li class="search" data-position="bottom" data-tooltip="Search all sites by keyword">
		  		<div class="search-wrapper">
		  			<i class="material-icons">search</i>
		  			<input id='search' class='' placeholder='Search..' />
		  			<i id="close_search" class="material-icons" style="display:none" onclick="clearFilters()">close</i>
		  		</div>
		  	</li>
		  	<li class="nav-subheading divider"></li>
		  	<ul class="collapsible" data-collapsible="expandable"> 
		 	<li class="journey-menu">
				<div class="collapsible-header" data-position="top" data-tooltip="Get directions to visit these sites"><i class="material-icons">navigation</i> <span onclick="createJourney()">Start your Journey</span></div>
				<div class="collapsible-body">
					<div id='directions'>
						<div id='routes'></div>
						<div id='instructions'></div>
						<div id='errors'></div>
					</div>	
				</div>
				</li>
			</ul>
			<li class="" data-position="top" data-tooltip="Locate yourself on the map"><a href="#" id="geolocate"><i class="material-icons" >gps_not_fixed</i><strong> Where am I?</strong></a></li>
			
			<ul class="collapsible" data-collapsible="expandable"> 
		 	<li class="filter-menu">
		 		<div class="collapsible-header" data-position="top" data-tooltip="Select the guided tour routes by theme"><strong><i class="material-icons">filter_list</i> Filter by theme</strong></div>
				<div class="collapsible-body">
					<ul>
					<li class="active" data-walk='ecology'><input type="checkbox" id="ecology" class="filter" onclick="filter(this)" data-walk='ECOLOGY IN THE CITY (environmental remediation)' /><label class="filter-label" for="ecology">Ecology</label></li>
					<li class="active" data-walk='citizens'><input type="checkbox" id="citizens" class="filter" onclick="filter(this)" data-walk="LANDSCAPES FOR CITIZENS - remembrance, recreation, children's spaces, returning space to citizens"/><label class="filter-label" for="citizens">Citizens</label></li>
					<li class="active" data-walk='political'><input type="checkbox" id="political" class="filter" onclick="filter(this)" data-walk="POLITICAL LANDSCAPES (civic demonstration & community events)"/><label class="filter-label" for="political">Political</label></li>
					<li class="active" data-walk='art'><input type="checkbox" id="art" class="filter" onclick="filter(this)" data-walk="ART IN THE LANDSCAPE & LANDSCAPE AS ART"/><label class="filter-label" for="art">Art</label></li>
					<li class="active" data-walk='intervetion'><input type="checkbox" id="intervention" class="filter" onclick="filter(this)" data-walk="LANDSCAPE INTERVENTIONS - new opportunities for landscapes"/><label class="filter-label" for="intervention">Intervention</label></li>
					<li class="active" data-walk='history'><input type="checkbox" id="history" class="filter" onclick="filter(this)" data-walk="HISTORIC LANDSCAPES"/><label class="filter-label" for="history">History</label></li>
					<li class="active" data-walk='urban'><input type="checkbox" id="urban" class="filter" onclick="filter(this)" data-walk="THE COGS OF THE CITY / URBAN MECHANICS (moving people - tram / bus / bike / car / walk / boat)"/><label class="filter-label" for="urban">Urban</label></li>
					<li class="active" data-walk='sport'><input type="checkbox" id="sport" class=" dark" onclick="filter(this)" data-walk="A SPORTING CITY"/><label class="filter-label-dark" for="sport">Sport</label></li>
					<li class="active" data-walk='miscellaneous'><input type="checkbox" id="miscellaneous" class="filter" onclick="filter(this)" data-walk="MISCELLANEOUS"/><label class="filter-label" for="miscellaneous">Miscellaneous</label></li>
					<li class="active" data-walk='uncategorized'><input type="checkbox" id="uncategorized" class="filter" onclick="filter(this)" data-walk="uncategorized"/><label class="filter-label" for="uncategorized">Uncategorized</label></li>
				</ul>
				</div>
		 	</li>
			</ul>
			
		 	<!-- <li class=""><i class="material-icons">help</i> Help</li>
				
			<ul class="collapsible" data-collapsible="expandable"> 
		 	<li class="">
				<div class="collapsible-header"><i class="material-icons">settings</i> Settings</div>
				<div class="collapsible-body">

				</div>
				</li>
			</ul> -->


			<!-- <li class="divider"></li> -->
			<!-- <li class=""><span><i class="material-icons">bookmark</i> Bookmark this journey</span></li> -->

			<!-- <ul class="collapsible" data-collapsible="expandable"> 
		 	<li class="">
				<div class="collapsible-header"><i class="material-icons">help</i> Help</div>
				<div class="collapsible-body"></div>
				</li>
			</ul> -->

		  </ul>
		  <a href="#" id="menu" data-activates="slide-out" class="button-collapse right show-on-large"><i class="mdi-navigation-menu"></i></a>
		</nav>		
		</div>
		<!-- <a class="dropdown-button" href="#" data-activates="dropdown1">Drop Me!</a><ul id="dropdown1" class="dropdown-content"><li><a href="#!">one</a></li><li><a href="#!">two</a></li><li class="divider"></li><li><a href="#!">three</a></li></ul> -->
		
		<div class="row">
 		<div id='map' class='custom-popup'></div>
 		<div class="touchtobegin noselect">
 		</div>
		<!-- <div id='inputs'></div> -->
		
		
		</div>

		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src='mapbox.directions.js'></script>
		

		<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.4/Leaflet.fullscreen.min.js'></script>
		<script src='bouncemarker.js'></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
		<script type="text/javascript">
		function getParameterByName(name) {
		    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		        results = regex.exec(location.search);
		    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		function is_touch_device() {
		  return 'ontouchstart' in window // works on most browsers 
		      || 'onmsgesturechange' in window; // works on ie10
		};

		$(document).ready(function() {

			$('.touchtobegin').text((is_touch_device() ? 'TOUCH HERE' : 'CLICK HERE' )).click(function(){
				activateMap(true);
				$(this).hide()
			})

			activateMap(false);

			$('.journey-menu').hide();

		    $('select').material_select();

		    window.onkeydown = function(e) {
		        if (e.keyCode == 9) {
		            e.preventDefault();
		        }
		    }

		    $(".button-collapse").sideNav({
		        menuWidth: 300, // Default is 240
		        edge: 'right', // Choose the horizontal origin
		        // closeOnClick: true // Closes side-nav on <a> clicks, useful for Angular/Meteor);
		    });

		    $('.side-nav input[type="checked"]').bind('click', function() {
		        $(this).trigger('click');

		    });

		    $('#menu').click(function() {
		        toast = true;
		        $('#search').focus();
		    })

		    $('.collapsible').collapsible({
		        accordion: false // A setting that changes the collapsible behavior to expandable instead of the default accordion style
		    });

		    $('.tooltipped').tooltip({
		        delay: 450,
		    });


		    $(document).click(function(event) {
		        if (!$(event.target).closest('.dropdown-activator').length && (event.target.className !== "addToJourney")) {
		            if ($('#dropdown1').is(":visible")) {
		                $('.leaflet-popup-content .card').css("overflow", "hidden")
		                $('#dropdown1').hide()
		            }
		        }
		    })

		    function activateMap(state){
		    	if (!state){
			    	map.dragging.disable();
					map.touchZoom.disable();
					map.doubleClickZoom.disable();
					map.scrollWheelZoom.disable();
					// Disable tap handler, if present.
					if (map.tap) map.tap.disable();
				} else {
					map.dragging.enable();
					map.touchZoom.enable();
					map.doubleClickZoom.enable();
					map.scrollWheelZoom.enable();
					// Enable tap handler, if present.
					if (map.tap) map.tap.enable();
				}
		    }

		    $(document).keyup(function(e) {
		        // if (e.keyCode == 13) $('.save').click();     // enter
		        if (e.keyCode == 27) {
		            $('#search').blur();
		            // activateMap(false);
		            esc = true;
		            $('.button-collapse').sideNav('hide');
		            clearFilters();
		        } else {
		            esc = false;
		            // activateMap(true)
		        }
		    });

		})

		 L.mapbox.accessToken = 'pk.eyJ1IjoiZWRhbndlaXMiLCJhIjoiY2lmMTVtdWQ0MDRsOHNkbTV2OXd3cDNwNiJ9.MxWj73wGNEvrPSjsh6TJjw';

		var map = L.mapbox.map('map').setView([-37.8163, 144.9634], 15);
		map.attributionControl.setPosition('bottomleft');
		var stamenLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
		    attribution: 'Designed and coded by <a href="http://twitter.com/edanweis">@edanweis</a>, Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://aila.org.au">AILA Victoria</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'
		}).addTo(map);
		var featureLayer = L.mapbox.featureLayer()
		var locationLayer = L.mapbox.featureLayer()
		var journeyLayer = L.mapbox.featureLayer()
		var allLayers = L.featureGroup([journeyLayer, featureLayer, locationLayer]).addTo(map)
		var jfLayers = L.featureGroup([journeyLayer])
		 L.control.fullscreen().addTo(map);
		var bounce = true; // Bounce markers on map when true
		var toast = true; // don't repeat more toasts when false
		var esc = false; // hide side-nav when true
		var journey = []; // Stores array of markers added to journey 
		var user_location; // Stores a L.latLng() object of user's GPS location.
		var last_added; // Marker last added, to prevent repeat of origin and destinations causing error.
		var geojson;
		var maxWaypoints = 26;
		var touchToStart = true;

		function getData() {
		    return $.ajax({
		        type: 'GET',
		        dataType: 'json',
		        url: "https://rawgit.com/edanweis/thejourney15/master/thejourney15_xc_1.geojson" //"thejourney15_ew_1.geojson" // REMEMBER TO CHANGE THIS TO AILA-VIC MASTER REPO.
		    });
		}

		function handleData(data /* , textStatus, jqXHR */ ) {
		    geojson = L.geoJson(data, {
		        onEachFeature: onEachFeature,
		        // filter : filter
		    })
		    geojson.addTo(map)
		    readJourney(getParameterByName('j')) // Example query get.
		}
		getData().done(handleData);

		var directions = L.mapbox.directions({
		    profile: 'mapbox.walking', // ability to change this
		    units: 'metric'
		});
		var directionsLayer = L.mapbox.directions.layer(directions)
		    .addTo(map);
		var directionsInputControl = L.mapbox.directions.inputControl('inputs', directions)
		    .addTo(map);
		var directionsErrorsControl = L.mapbox.directions.errorsControl('errors', directions)
		    .addTo(map);
		var directionsRoutesControl = L.mapbox.directions.routesControl('routes', directions)
		    .addTo(map);
		var directionsInstructionsControl = L.mapbox.directions.instructionsControl('instructions', directions)
		    .addTo(map);


		$('#search').keyup(search);



		function onEachFeature(feature, layer) {
		    layer.on({
		        // mouseover: mouseover,
		        // mouseout: mouseout,
		        layeradd: onLayerAdd(feature, layer)
		    });
		}


		function getIcon(layer) {

		    var feature = layer.feature
		    switch (feature.properties.WALK) {
		        case "ECOLOGY IN THE CITY (environmental remediation)":
		            var fill_color = 'green';
		            break;
		        case "LANDSCAPES FOR CITIZENS - remembrance, recreation, children's spaces, returning space to citizens":
		            var fill_color = 'blue';
		            break;
		        case "POLITICAL LANDSCAPES (civic demonstration & community events)":
		            var fill_color = 'red';
		            break;
		        case "ART IN THE LANDSCAPE & LANDSCAPE AS ART":
		            var fill_color = 'acqua';
		            break;
		        case "LANDSCAPE INTERVENTIONS - new opportunities for landscapes":
		            var fill_color = 'purple';
		            break;
		        case "HISTORIC LANDSCAPES":
		            var fill_color = 'beige';
		            break;
		        case "THE COGS OF THE CITY / URBAN MECHANICS (moving people - tram / bus / bike / car / walk / boat)":
		            var fill_color = 'orange';
		            break;
		        case "A SPORTING CITY":
		            var fill_color = 'yellow';
		            break;
		        case "MISCELLANEOUS":
		            var fill_color = 'pink';
		            break;
		        case "uncategorized":
		            var fill_color = 'black';
		            break;

		        default:
		            var fill_color = 'black';
		    }

		    if (feature.properties.addedToJourney) {
		        iconUrl = (feature.properties.photo ? feature.properties.photo : "img/landscape.png"); //"img/ic_location_selected.svg"
		        w = 64;
		        h = 64;
		        iax = 28;
		        iay = 48;
		        pax = 0;
		        pay = -32;
		        sax = 12;
		        say = 26;
		        className = "selected circle"

		    } else {
		        iconUrl = "img/ic_location_on_black_24px_" + fill_color + ".svg";
		        w = 32;
		        h = 32;
		        iax = 11;
		        iay = 32;
		        pax = 0;
		        pay = -32;
		        sax = 12;
		        say = 26;
		        className = "dot"

		    }

		    return {
		        "iconUrl": iconUrl, //"https://www.iconfinder.com/icons/299087/download/svg/32",
		        "iconSize": [w, h], // size of the icon
		        "iconAnchor": [iax, iay], // point of the icon which will correspond to marker's location
		        "popupAnchor": [pax, pay], // point from which the popup should open relative to the iconAnchor
		        "className": className,
		        "shadowUrl": 'img/shadow.png',
		        "shadowAnchor": [sax, say],
		        "shadowSize": [32, 32],
		    }
		}

		function onLayerAdd(feature, layer) {
		    var icon = getIcon(layer);

		    var icon_person = {
		        "iconUrl": "img/ic_person_pin_50px.svg",
		        "iconSize": [50, 50], // size of the icon
		        "iconAnchor": [25, 50], // point of the icon which will correspond to marker's location
		        "popupAnchor": [-5, 50], // point from which the popup should open relative to the iconAnchor
		        "className": "dot"

		    }
		    var content_person = '<div class="card-panel white" id=' + feature.properties.PK + '><span class="">You are Here!</span></div>'
		    if (feature.properties.designer) var hashTag = encodeURIComponent(feature.properties.designer.replace(/\,\s/g, '~').replace(/\s/g, '').replace(/\~/g, ' ')) //.toProperCase()
		    
		    
		    // format the url for a tweet (get rid of j parameter and create p (or pk) parameter)
		    var uri = encodeURIComponent(UpdateQueryString("j",null, UpdateQueryString("p",feature.properties.PK)))
		    

		    // Style Popup and create HTML
		    card = '<div class="card" id="' + feature.properties.PK + '">' +
		        '<div class="card-image waves-effect waves-block waves-light">' +
		        '<img class="activator" src="' + (feature.properties.photo ? feature.properties.photo : "img/landscape.jpg") + '"/>' +
		        '</div>' +
		        '<div class="card-content">' +
		        '<span class="card-title grey-text text-darken-4">' +
		        '<i class="material-icons right dropdown-activator" data-activates="dropdown1" onclick="openDropdown(this)">more_vert</i>' + feature.properties.project + '</span>' +
		        '<p>' + ((feature.properties.url) ? '<a href="' + feature.properties.url + '</a>' : '<a href="http://www.google.com/search?q=' + encodeURIComponent(feature.properties.designer) + '%20site:au&btnI" target="_blank">' + feature.properties.designer +
		            '</a></p><ul id="dropdown1" class="dropdown z-depth-2" ><li class="addToJourney">') +
		        ((feature.properties.addedToJourney) ? '<span class="addToJourney" onclick="removeFromJourney(this,' + feature.properties.PK + ')"><i class="material-icons" style="color:red">remove</i> Remove this site</span>' : '<span class="addToJourney" onclick="addToJourney(this,' + feature.properties.PK + ')"><i class="material-icons green-text">add</i> Add to Journey</span>') + '</li>' + '<li><a href="https://twitter.com/intent/tweet?url='+uri+'&text=Check out '+hashTag+' @TheJourney — Interactive Landscape Tour Map'+'" onclick="window.open(this.href);return false;"><img src="img/twitter.svg" class="twitter-icon" /> Tweet location</a></li></ul>' +
		        '</div>' +
		        '<div class="card-reveal">' +
		        '<span class="card-title grey-text text-darken-4">' +
		        '<i class="material-icons right">close</i>' + feature.properties.project + '</span>' + ((feature.properties.address) ? '<p class="address">' + feature.properties.address + '</p>' : '') +
		        '<p class="project-description">' + feature.properties.description + '</p></div></div>'

		  //      var cd = $('<div/>').html(c).contents();
		  //      var card = $('<div/>').html(c).contents()[0];
		  //      var mc = new Hammer.Manager(card);
				// var pinch = new Hammer.Pinch();
				// // add to the Manager
				// mc.add([pinch]);
				// mc.on("pinch", function(ev) {
				//     alert('pinched')
				// });			

		       

		    //it's been added to the journey layer
		    if (feature.properties.addedToJourney) {
		        layer.bindPopup(card);
		        // layer.options.zIndexOffset = -1;
		        // layer.options.clickable = false;
		        layer.setIcon(L.icon(icon)).addTo(journeyLayer)
		        featureLayer.removeLayer(layer)
		        journey.push(layer);
		        last_added = layer
		        
		        // updateURI() /// use this to start saving and loading route.
		        if (journey.length>1) $('.journey-menu').show();

		        // it is the location person icon
		    } else if (feature.properties.person) {
		        layer.setIcon(L.icon(icon_person)).addTo(locationLayer)
		        layer.bindPopup(content_person);
		        journey.push(layer);
		        // layer.openPopup();
		    }
		    // its a standard layer/marker/feature.
		    else {
		        layer.bindPopup(card);
		        featureLayer.removeLayer(layer)
		        layer.setIcon(L.icon(icon)).addTo(featureLayer)
				
		    };

		    // check if max waypoints reached
		    if (journey.length == maxWaypoints) {
		        Materialize.toast("Take a break! Or start another journey - 26 sites is the limit.", 6000)
		    }

		    if (bounce == true) {
		        layer.bounce()
		    };


		}


		String.prototype.toProperCase = function () {
		    return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
		};

		function openDropdown(e) {
		    $('.leaflet-popup-content .card').css("overflow", "visible")

		    if (journey.length == maxWaypoints) {

		        // featureLayer.eachLayer(function(marker) {
		        var markers = []
		        for (var i = 0; i < journey.length; i++) {
		            markers.push(journey[i].feature.properties.PK)
		        }
		        if (markers.indexOf(parseInt($(e).parents('.card').attr('id'))) == -1) {
		            $(e).parent().parent().find('li').first().html('<span class="addToJourney disabled tooltipped" style="color:#ddd"><i class="material-icons nav-icon" style="color:#ddd">navigation</i> Add to Journey</span>')
		            $(e).parent().parent().find('li').first().attr('data-tooltip', 'Take a break! Or start another journey - 26 sites is the limit.')
		            $(e).parent().parent().find('li').first().tooltip({
		                delay: 250,
		                position: 'top'
		            });
		        }


		    }
		    var activate = $(e).attr('data-activates')
		    $('#' + activate).toggle();

		}

		function createJourney() {
		    if (journey.length == 1) {
		        directions._unload();
		        // tell the user only 1 marker has been selected.
		    } else if (journey.length >= 2) {
		        directions._unload();
		        var journey_sorted = findClosest(journey, user_location);

		        directions.setOrigin(getMarker(journey_sorted[0]).getLatLng())
		        directions.setDestination(getMarker(journey_sorted[1]).getLatLng())
		        for (i = 2; i < journey_sorted.length; ++i) {
		            var waypoint = getMarker(journey_sorted[i]).getLatLng();
		            directions.addWaypoint(i - 2, waypoint)
		        }
		        directions.query();
		    }
		}

		function getMarker(pk) {
		    var got_marker;
		    journeyLayer.eachLayer(function(marker) {
		        if (marker.feature.properties.PK == pk) {
		            got_marker = marker
		        }
		    })
		    locationLayer.eachLayer(function(marker) {
		        if (marker.feature.properties.PK == pk) {
		            got_marker = marker
		        }
		    })
		    return got_marker
		};

		function addToJourney(e, pk) {
		    bounce = false;
		    if(e){
		    	$(e).html('<i class="material-icons" style="color:green;">check</i> Added')
		    }
		    
		    featureLayer.eachLayer(function(marker) {
		        if ((marker.feature.properties.PK == pk) && (marker !== last_added)) {
		            var m_geojson = marker.toGeoJSON();
		            m_geojson.properties.addedToJourney = true;
		            geojson.addData(m_geojson)
		            last_added = marker;
		            createJourney();
		        }
		    });
		}

		function readJourney(journey){
			if (journey){				
				var route = journey.split(',');
				featureLayer.eachLayer(function(marker) {
					var pk = marker.feature.properties.PK
					if (route.indexOf(String(pk)) !== -1){
						addToJourney('', pk)
					}
				})
			}
		}

		function removeFromJourney(e, pk) {
		    $(e).html('<i class="material-icons nav-icon">navigation</i> Add to Journey')

		    journeyLayer.eachLayer(function(marker) {
		        if (marker.feature.properties.PK == pk) {
		            if (marker !== last_added) {}
		            journey.splice($.inArray(marker, journey), 1);
		            createJourney();
		            var m_geojson = marker.toGeoJSON();
		            journeyLayer.removeLayer(marker);
		            m_geojson.properties.addedToJourney = false;
		        }
		    })


		}

		function findClosest(journey, user_location) {
		    if (!user_location) {
		        user_location = journey[0].getLatLng(); // Ask the user for their location, or use the first marker selected.
		    }
		    var journey_sorted = []
		    for (i = 0; i < journey.length; ++i) {
		        journey_sorted[journey[i].feature.properties.PK] = distance(user_location.lat, user_location.lng, journey[i].getLatLng().lat, journey[i].getLatLng().lng)
		    }
		    journey_sorted = Object.keys(journey_sorted).sort(function(a, b) {
		        return journey_sorted[a] - journey_sorted[b]
		    });
		    return journey_sorted
		};

		function distance(lat1, lon1, lat2, lon2) {
		    var p = 0.017453292519943295; // Math.PI / 180
		    var c = Math.cos;
		    var a = 0.5 - c((lat2 - lat1) * p) / 2 +
		        c(lat1 * p) * c(lat2 * p) *
		        (1 - c((lon2 - lon1) * p)) / 2;

		    return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
		}

		 // add hover to Popup windows
		allLayers.eachLayer(function(layer) {
		    layer.on('mouseover', function(e) {
		        featureLayer.eachLayer(function(marker) {
		            // How to exclude journey markers from opacity change?
		            if (marker.feature.properties.WALK !== e.layer.feature.properties.WALK) {
		                marker.setOpacity(0.2);
		            }
		        });
		        journeyLayer.eachLayer(function(marker) {
		            // How to exclude journey markers from opacity change?
		            if (marker.feature.properties.WALK !== e.layer.feature.properties.WALK) {
		                marker.setOpacity(0.2);
		            }
		        });
		    });
		});

		function updateURI(){
			var bookmark = $.map(journey, function(obj){
				if(obj.feature.properties.PK !==0) return obj.feature.properties.PK
			}).join(',');
	        uri = UpdateQueryString('j',bookmark)
	        var currentState = window.history.state;
	        if (window.history.replaceState) {
			   window.history.replaceState(currentState, document.title, uri);
			}
		};

		allLayers.eachLayer(function(layer) {
		    layer.on('click', function(e) {
		        e.layer.openPopup();
		        // console.log(directions.queryURL())
		    });
		});

		allLayers.eachLayer(function(layer) {
		    layer.on('mouseout', function(e) {
		        featureLayer.eachLayer(function(marker) {
		            marker.setOpacity(1);
		        });
		        journeyLayer.eachLayer(function(marker) {
		            marker.setOpacity(1);
		        });
		    })
		});

		locationLayer.on('mouseover', function(e) {
		    e.layer.openPopup();
		}).on('click', function(e) {
		    e.layer.openPopup();
		});

		locationLayer.on('mouseout', function(e) {})

		 // filter

		function filter(e) {

		    var searchString = $('#search').val().toLowerCase();
		    if (e) {
		        if (e.className == 'filter filtered') {
		            e.className = 'filter'
		        } else {
		            e.className = 'filter filtered'
		        }
		    }

		    var filters = []
		    var categories_filtered = document.getElementsByClassName('filtered')
		    var categories_all = document.getElementsByClassName('filter')
		    console.log(categories_all)
		    
		    if (categories_filtered.length == 0){
		    	var categories = categories_all;
			} else {
				var categories = categories_filtered
			}

		    for (var i = 0; i < categories.length; i++) {
		        filters.push(categories[i].dataset.walk);
		    }

		    featureLayer.eachLayer(function(marker) {
		        if (((marker.feature.properties.description + ' ' + marker.feature.properties.client + ' ' + marker.feature.properties.designer + ' ' + marker.feature.properties.address).toLowerCase().indexOf(searchString) !== -1) && marker.feature.properties.WALK && (filters.indexOf(marker.feature.properties.WALK) !== -1)) {

		            var icon = getIcon(marker);
		            marker.setIcon(L.icon(icon)).addTo(featureLayer)
		        } else {
		            marker.setIcon(L.icon({
		                "iconUrl": "img/b.svg",
		                "className": "hidden"
		            })).addTo(featureLayer)
		        }

		    })
		}

		function search() {
		    bounce = false;

		    ($('#search').val() ? $('#close_search').css("display", 'inline') : $('#close_search').css("display", 'none'))

		    var filters = []
		    var list = document.getElementsByClassName('filtered')

		    for (var i = 0; i < list.length; i++) {
		        if (list[i].className == "filtered") filters.push(list[i].dataset.walk);
		    }


		    // get the value of the search input field
		    var searchString = $('#search').val().toLowerCase();
		    // featureLayer.setFilter(showState);

		    // here we're simply comparing the various properties of each marker
		    // to the search string, seeing whether the former contains the latter.
		    filter()


		    // if ((toast) && (esc == false) && $('#search').val().length > 0) {
		    //     Materialize.toast('Results by keyword', 3000, 'toast', function() {
		    //         toast = true;
		    //         esc = true;
		    //     });
		    //     toast = false;
		    // }
		}

		function clearFilters() {
		    $('#search').val('');
		    search();
		    $('#close_search').css('display', 'none');
		}



		 // find the user's location

		if (!navigator.geolocation) {
		    geolocate.innerHTML = '<i class="material-icons">gps_off</i> Geolocation is not available <a href="#" id="geolocate" class="try-again" style="display:inline;">(try again)</a>';
		} else {
		    geolocate.onclick = function(e) {
		        e.preventDefault();
		        e.stopPropagation();
		        map.locate();
		    };
		}
		 // Once we've got a position, zoom and center the map
		 // on it, and add a single marker.
		map.on('locationfound', function(e) {
		    user_location = L.latLng(e.latlng.lat, e.latlng.lng)
		    map.fitBounds(e.bounds).setZoom(14);
		    geolocate.innerHTML = '<i class="material-icons">gps_fixed</i> Found <a href="#" id="geolocate" class="try-again" style="display:inline;">(relocate)</a>';
		    var l_geojson = {
		        type: "FeatureCollection",
		        features: [{
		            type: "Feature",
		            geometry: {
		                type: "Point",
		                coordinates: [e.latlng.lng, e.latlng.lat]
		            },
		            properties: {
		                person: true,
		                PK: 0
		            }
		        }]
		    }
		    geojson.addData(l_geojson)
		});

		 // If the user chooses not to allow their location
		 // to be shared, display an error message.
		map.on('locationerror', function() {
		    geolocate.innerHTML = '<i class="material-icons">error</i> We lost you. <a href="#" id="geolocate" class="try-again" style="display:inline;">(try again)</a>';
		})


		function UpdateQueryString(key, value, url) {
		    if (!url) url = window.location.href;
		    var re = new RegExp("([?&])" + key + "=.*?(&|#|$)(.*)", "gi"),
		        hash;

		    if (re.test(url)) {
		        if (typeof value !== 'undefined' && value !== null)
		            return url.replace(re, '$1' + key + "=" + value + '$2$3');
		        else {
		            hash = url.split('#');
		            url = hash[0].replace(re, '$1$3').replace(/(&|\?)$/, '');
		            if (typeof hash[1] !== 'undefined' && hash[1] !== null) 
		                url += '#' + hash[1];
		            return url;
		        }
		    }
		    else {
		        if (typeof value !== 'undefined' && value !== null) {
		            var separator = url.indexOf('?') !== -1 ? '&' : '?';
		            hash = url.split('#');
		            url = hash[0] + separator + key + '=' + value;
		            if (typeof hash[1] !== 'undefined' && hash[1] !== null) 
		                url += '#' + hash[1];
		            return url;
		        }
		        else
		            return url;
		    }
		}

		</script>
	</body>
</html>