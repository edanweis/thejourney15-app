<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>
			thejourney.aila.org.au
		</title>
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no, width=device-width'>
		<link href='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.css' rel='stylesheet' type="text/css">
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
		<link rel='stylesheet' href='mapbox.directions.css' type='text/css' />
		<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
		<link rel='stylesheet' href='style.css' type='text/css' />
		<!-- <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.4/leaflet.fullscreen.css' rel='stylesheet' /> -->
		<script src='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.js' type="text/javascript"></script>
		<link rel="stylesheet" type="text/css" href="nouislider.css">
		<script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
		 <script src="https://hammerjs.github.io/dist/hammer.js"></script>
		 <meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:site" content="@TheJourney">
		<meta name="twitter:creator" content="@TheJourney">
		<meta name="twitter:title" content="The Journey 2015">
		<meta name="twitter:description" content="Interactive Landscape Tour Map">
		<meta name="twitter:image" content="http://thejourney.aila.org.au/wp-content/uploads/2015/09/The_Journey-Logo-Colour.png">
	</head>
	<body>
	
	 		<!-- <div id="darken"></div> -->
		
		<nav class="noselect">
		  <ul id="slide-out" class="side-nav show-on-large select">
		  	<li class="search" data-position="bottom" data-tooltip="Search all sites by keyword">
		  		<div class="search-wrapper">
		  			<i class="material-icons">search</i>
		  			<input id='search' class='' placeholder='Search..' />
		  			<i id="close_search" class="material-icons" style="display:none" onclick="clearFilters()">close</i>
		  		</div>
		  	</li>
		  	<li class="nav-subheading divider"></li>
			<li class="" data-position="top" data-tooltip="Locate yourself on the map"><a href="#" onclick="map.locate({watch:true,enableHighAccuracy:true, setView: true})"id="geolocate"><i class="material-icons" >gps_not_fixed</i><strong> Where am I?</strong></a></li>
			<li class="" data-position="top" data-tooltip="Get Google directions"><a href="#" target="_blank" id="googledirections" onclick="googleURL()"><img src="img/gmap.png" class="gmap-icon"><strong> Get Directions in Google Map</strong></a></li>
			<ul class="collapsible" data-collapsible="expandable"> 
		 	<li class="filter-menu">
		 		<div class="collapsible-header" data-position="top" data-tooltip="Select the guided tour routes by theme"><strong><i class="material-icons">filter_list</i> Filter by theme</strong></div>
				<div class="collapsible-body">
					<ul>
					<li class="active waves-effect waves-light" data-walk='ecology'><input type="checkbox" id="ecology" class="filter" onclick="filter(this)" data-walk='ECOLOGY IN THE CITY (environmental remediation)' /><label class="filter-label" for="ecology">Ecology in the City</label></li>
					<li class="active waves-effect waves-light" data-walk='citizens'><input type="checkbox" id="citizens" class="filter" onclick="filter(this)" data-walk="LANDSCAPES FOR CITIZENS - remembrance, recreation, children's spaces, returning space to citizens"/><label class="filter-label" for="citizens">Landscapes for Citizens</label></li>
					<li class="active waves-effect waves-light" data-walk='political'><input type="checkbox" id="political" class="filter" onclick="filter(this)" data-walk="POLITICAL LANDSCAPES (civic demonstration & community events)"/><label class="filter-label" for="political">Political Landscapes</label></li>
					<li class="active waves-effect waves-light" data-walk='art'><input type="checkbox" id="art" class="filter" onclick="filter(this)" data-walk="ART IN THE LANDSCAPE & LANDSCAPE AS ART"/><label class="filter-label" for="art">Art in the Landscape</label></li>
					<li class="active waves-effect waves-light" data-walk='intervetion'><input type="checkbox" id="intervention" class="filter" onclick="filter(this)" data-walk="LANDSCAPE INTERVENTIONS - new opportunities for landscapes"/><label class="filter-label" for="intervention">Landscape Interventions</label></li>
					<li class="active waves-effect waves-light" data-walk='history'><input type="checkbox" id="history" class="filter" onclick="filter(this)" data-walk="HISTORIC LANDSCAPES"/><label class="filter-label" for="history">Historic Landscapes</label></li>
					<li class="active waves-effect waves-light" data-walk='urban'><input type="checkbox" id="urban" class="filter" onclick="filter(this)" data-walk="THE COGS OF THE CITY / URBAN MECHANICS (moving people - tram / bus / bike / car / walk / boat)"/><label class="filter-label" for="urban">Urban Mechanics - the Cogs of the City</label></li>
					<li class="active waves-effect waves-dark" data-walk='sport'><input type="checkbox" id="sport" class="dark" onclick="filter(this)" data-walk="A SPORTING CITY"/><label class="filter-label-dark" for="sport">A Sporting City</label></li>
					<!-- <li class="active waves-effect waves-light" data-walk='miscellaneous'><input type="checkbox" id="miscellaneous" class="filter" onclick="filter(this)" data-walk="MISCELLANEOUS"/><label class="filter-label" for="miscellaneous">Miscellaneous</label></li> -->
					<!-- <li class="active waves-effect waves-light" data-walk='uncategorized'><input type="checkbox" id="uncategorized" class="filter" onclick="filter(this)" data-walk="uncategorized"/><label class="filter-label" for="uncategorized">Uncategorized</label></li> -->
				</ul>
				</div>
		 	</li>
			</ul>
			<li class="nav-subheading divider"></li>
			<div class="att" id="attribution">Developed by <a href="http://twitter.com/edanweis">@edanweis</a></span> Map tiles by <a href="http://stamen.com">Stamen Design</a></div>

		  </ul>
		  <a href="#" id="menu" data-activates="slide-out" class="button-collapse right show-on-large waves-effect waves-light tooltipped" data-position="left" data-tooltip="Menu"><i class="mdi-navigation-menu"></i></a>
		</nav>		
			<!-- <div id="attribution" class="noselect noevents"><p>Designed and developed by <a href="http://twitter.com/edanweis" target="_blank" >@edanweis</a>. Map tiles by <a href="http://stamen.com">Stamen Design</a></p></div> -->
			<div class="fullscreen waves-effect waves-light tooltipped" data-position="right" data-tooltip=""><a href="http://thejourney.aila.org.au/map" target="_top"><i class="material-icons">fullscreen</i></a></div>
		<div class="row">
	 		<div id='map' class='custom-popup noselect'></div>
	 		<div class="touchtobegin noselect"></div>
		</div>
		<div class="navigation-pane z-depth-1">
			<div id="slider-bg"></div>
			<div id="slider" class="events"></div>
			<div class="mode waves-effect waves-light events tooltipped" data-position="bottom" data-tooltip="Change transport mode">
				<div id="walking" class="transport events active"><i class="material-icons">directions_walk</i></div>
				<div id="cycling" class="transport events"><i class="material-icons">directions_bike</i></div>
				<div id="driving" class="transport events"><i class="material-icons">directions_car</i></div>
        		<div id="duration" class="">2 min</div>
			</div>
			<div class="instructions events noselect">
				<div id="steps"></div>
        		<div id="maneuver"></div>
        	<div id="distance"></div>
			            
			</div>
			<div id="direction">
        			<img src="" class="direction-icon" />
    		</div>
		</div>

		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src='mapbox.directions.js'></script>
		<script src='bouncemarker.js'></script>
		<script src="materialize.js"></script>
		<script type="text/javascript" src="nouislider.js"></script>
		<script type="text/javascript">

		
		//JQUERY TO BIND EVENTS TO NON-DYNAMIC ELEMENTS.

		$(document).ready(function() {

			
			if(inIframe()){
				$('.fullscreen a').attr('href', 'http://thejourney.aila.org.au/map');
				$('button-collapse').addClass('iframe');
				$('.fullscreen i').text("fullscreen");
				$('.fullscreen').attr('data-tooltip', 'Enter Fullscreen');
				$('.fullscreen').tooltip();

			} else{
				$('.fullscreen i').text("fullscreen_exit");
				$('.fullscreen a').attr('href', 'http://thejourney.aila.org.au');
				$('.fullscreen').attr('data-tooltip', 'Back to The Journey Website');
				$('.fullscreen').tooltip()
			}

		    activateMap(false, false);

		    $('.touchtobegin').text((is_touch_device() ? 'TOUCH TO START' : 'CLICK TO START')).show()

		    $('#search').keyup(search);

		    $('.touchtobegin').click(function() {
		        if (!map.dragging.enable()) {
		            $('.touchtobegin').hide();
		            activateMap(true, true)

		        }
		    })

		    $('#menu').click(function() {
		        if (!map.dragging._enabled) {
		            $('.touchtobegin').hide()
		            activateMap(true, true);
		        }
		    });

		    $('.journey-menu').hide();


		    var slider = $('#slider')[0]

		    noUiSlider.create(slider, range_settings);
		    bindValue();

		    window.onkeydown = function(e) {
		        if (e.keyCode == 9) {
		            e.preventDefault();
		        }
		    }

		    $(".button-collapse").sideNav({
		        menuWidth: ($(window).width() > 768 ? 300 : 200), // Default is 240
		        edge: 'right', // Choose the horizontal origin
		        closeOnClick: false
		        // closeOnClick: true // Closes side-nav on <a> clicks, useful for Angular/Meteor);
		    });

		    $('.side-nav input[type="checked"]').bind('click', function() {
		        $(this).trigger('click');

		    });

		    $('#menu').click(function() {
		        toast = true;
		        if (!is_touch_device()) {
		            $('#search').focus();
		        }

		    })

		    $('.collapsible').collapsible({
		        accordion: false 
		    });

		    $('.tooltipped').tooltip({
		        delay: 450,
		    });

		    $('.instructions').click(function() {
		        slider.noUiSlider.set(parseInt(slider.noUiSlider.get()) + 1);
		    })


		    $(".mode").click(function() {
		        var $selected = $("div.active").removeClass("active");
		        var divs = $selected.parent().children('.transport');
		        divs.eq((divs.index($selected) + 1) % divs.length).addClass("active");
		        currentProfile = $("div.active").attr('id')
		        directions.profile = 'mapbox.' + currentProfile;
		        $('#maneuver').html("")
		        $('#distance').html("")
		        $('#duration').html("&nbsp")
		        $('.direction-icon').attr('src', "img/blank.svg")
		        createJourney(true);
		    });


		    $(document).click(function(event) {
		        if (!$(event.target).closest('.dropdown-activator').length && (event.target.className !== "addToJourney")) {
		            if ($('#dropdown1').is(":visible")) {
		                $('.leaflet-popup-content .card').css("overflow", "hidden")
		                $('#dropdown1').hide()
		            }
		        }
		    })

		    function activateMap(state, bounce) {
		        if (!state) {
		            map.dragging.disable();
		            map.touchZoom.disable();
		            map.doubleClickZoom.disable();
		            map.scrollWheelZoom.disable();
		            $('#map').css("pointer-events", "none");
		            // Disable tap handler, if present.
		            if (map.tap) map.tap.disable();
		        } else {
		            $('#map').css("pointer-events", "auto");
		            if (bounce) bounceMarkers()
		            map.dragging.enable();
		            map.touchZoom.enable();
		            map.doubleClickZoom.enable();
		            map.scrollWheelZoom.enable();
		            // Enable tap handler, if present.
		            if (map.tap) map.tap.enable();
		        }
		    }

		    // var from_tweet = getParameterByName('p').replace('#', '').replace('/', '')
		    // if (from_tweet) {
		    //     featureLayer.eachLayer(function(marker) {
		    //         if (marker.feature.properties.PK == from_tweet) {
		    //             marker.openPopup();
		    //             getLatLng()
		    //             map.setView(marker.getLatLng())
		    //             return
		    //         }
		    //     })
		    // }

		    $(document).keyup(function(e) {
		        if (e.keyCode == 13){
		        	$('.button-collapse').sideNav('hide');
		        	$('#search').blur();
		        }

		        if (e.keyCode == 27) {
		            $('#search').blur();
		            // activateMap(false);
		            esc = true;
		            $('.button-collapse').sideNav('hide');
		            clearFilters();
		        } else {
		            esc = false;
		            // activateMap(true)
		        }
		    });

		})

		 // GLOBAL VARS AND INITIALIZATION

		 L.mapbox.accessToken = 'pk.eyJ1IjoiZWRhbndlaXMiLCJhIjoiY2lmMTVtdWQ0MDRsOHNkbTV2OXd3cDNwNiJ9.MxWj73wGNEvrPSjsh6TJjw';

		var map = L.mapbox.map('map', null, {
		    zoomControl: false
		}).setView([-37.8163, 144.9634], 15);
		map.attributionControl.setPosition('bottomright');
		var stamenLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
		    attribution: ''
		}).addTo(map);

		map.zoomControl = false;

		 // custom overlay doesn't work when zoomed out.
		 // var imageBounds = [[-70, -118], [70, 170]];
		 // L.imageOverlay("img/overlay.png", imageBounds, {opacity:0.5}).addTo(map);

		// L.control.fullscreen().setPosition("topleft").addTo(map);

		// global vars

		var featureLayer = L.mapbox.featureLayer()
		var locationLayer = L.mapbox.featureLayer()
		var journeyLayer = L.mapbox.featureLayer()
		var allLayers = L.featureGroup([journeyLayer, featureLayer, locationLayer]).addTo(map)
		var jfLayers = L.featureGroup([journeyLayer])
		var toast = true; // don't repeat more toasts when false
		var esc = false; // hide side-nav when true
		var journey = []; // Stores array of markers added to journey 
		var user_location; // Stores a L.latLng() object of user's GPS location.
		var last_added; // Marker last added, to prevent repeat of origin and destinations causing error.
		var geojson;
		var maxWaypoints = 26;
		var touchToStart = true;
		var route;
		var navDisplayed = false;
		var range_settings = {
		    start: 0,
		    connect: "lower",
		    step: 1,
		    range: {
		        'min': 0,
		        'max': 100
		    },
		    format: wNumb({
		        decimals: 0
		    })
		}
		var nav_directions;
		var currentProfile = 'walking';
		 // GET GEOJSON DATA FROM GITHUB USING AJAX

		function getData() {
		    return $.ajax({
		        type: 'GET',
		        dataType: 'json',
		        url: 'https://raw.githubusercontent.com/aila-vic/thejourney15/master/thejourney15_ew_12.geojson'

		    });
		}

		function handleData(data /* , textStatus, jqXHR */ ) {
		    geojson = L.geoJson(data, {
		        onEachFeature: onEachFeature,
		        // filter : filter
		    })
		    geojson.addTo(map)
		    readJourney(getParameterByName('j')) // Example query get.
		}
		getData().done(handleData);


		 // INITIALIZE DIRECTIONS

		var directions = L.mapbox.directions({
		    profile: 'mapbox.' + currentProfile, // ability to change this
		    units: 'metric'
		});
		var directionsLayer = L.mapbox.directions.layer(directions)
		    .addTo(map);
		var directionsInputControl = L.mapbox.directions.inputControl('inputs', directions)
		    .addTo(map);
		var directionsErrorsControl = L.mapbox.directions.errorsControl('errors', directions)
		    .addTo(map);
		var directionsRoutesControl = L.mapbox.directions.routesControl('routes', directions)
		    .addTo(map);
		var directionsInstructionsControl = L.mapbox.directions.instructionsControl('instructions', directions)
		    .addTo(map);


		 // BIND LAYER ADD FUNCTION TO EACH MARKER (LAYER/FEATURE)

		function onEachFeature(feature, layer) {
		    layer.on({
		        layeradd: onLayerAdd(feature, layer)
		    });
		}


		 // SET ICON FOR DIFFERENT CONTEXTS (PERSON, JOURNEY, STANDARD)

		function getIcon(layer) {
		    var feature = layer.feature
		    switch (feature.properties.WALK) {
		        case "ECOLOGY IN THE CITY (environmental remediation)":
		            var fill_color = 'green';
		            break;
		        case "LANDSCAPES FOR CITIZENS - remembrance, recreation, children's spaces, returning space to citizens":
		            var fill_color = 'blue';
		            break;
		        case "POLITICAL LANDSCAPES (civic demonstration & community events)":
		            var fill_color = 'red';
		            break;
		        case "ART IN THE LANDSCAPE & LANDSCAPE AS ART":
		            var fill_color = 'acqua';
		            break;
		        case "LANDSCAPE INTERVENTIONS - new opportunities for landscapes":
		            var fill_color = 'purple';
		            break;
		        case "HISTORIC LANDSCAPES":
		            var fill_color = 'beige';
		            break;
		        case "THE COGS OF THE CITY / URBAN MECHANICS (moving people - tram / bus / bike / car / walk / boat)":
		            var fill_color = 'orange';
		            break;
		        case "A SPORTING CITY":
		            var fill_color = 'yellow';
		            break;
		        // case "MISCELLANEOUS":
		        //     var fill_color = 'pink';
		        //     break;
		        default:
		            var fill_color = 'black';
		    }

		    if (feature.properties.addedToJourney) {
		        iconUrl = "img/photos/"+feature.properties.PK+".jpg";
		        w = 64;
		        h = 64;
		        iax = 38;
		        iay = 29;
		        pax = 0;
		        pay = 0;
		        sax = 12;
		        say = 26;
		        className = "selected circle"

		    } else {
		        iconUrl = "img/ic_location_on_black_24px_" + fill_color + ".svg";
		        w = 32;
		        h = 32;
		        iax = 16;
		        iay = 30;
		        pax = 0;
		        pay = -32;
		        sax = 16;
		        say = 26;
		        className = "dot"

		    }

		    return {
		        "iconUrl": iconUrl, //"https://www.iconfinder.com/icons/299087/download/svg/32",
		        "iconSize": [w, h], // size of the icon
		        "iconAnchor": [iax, iay], // point of the icon which will correspond to marker's location
		        "popupAnchor": [pax, pay], // point from which the popup should open relative to the iconAnchor
		        "className": className,
		        "shadowUrl": 'img/shadow.png',
		        "shadowAnchor": [sax, say],
		        "shadowSize": [32, 32],
		    }
		}


		 // LAYER ADD CALLS AS NEW MARKERS ARE ADDED

		function onLayerAdd(feature, layer) {
		    var icon = getIcon(layer);

		    var icon_person = {
		        "iconUrl": "img/ic_person_pin_50px.svg",
		        "iconSize": [50, 50], // size of the icon
		        "iconAnchor": [28, 25], // point of the icon which will correspond to marker's location
		        "popupAnchor": [-5, 50], // point from which the popup should open relative to the iconAnchor
		        "className": "dot"

		    }
		    var content_person = '<div class="card-panel white person-card" id=' + feature.properties.PK + '><span class="">You are Here!</span></div>'
		    var tweetsubject = (feature.properties.designer ? feature.properties.designer : feature.properties.project)
		    if (feature.properties.designer || feature.properties.project) {
		        var hashTag = encodeURIComponent(tweetsubject.replace(/\,\s/g, '~').replace(/\s/g, '').replace(/\~/g, ' ')) //.toProperCase()
		    }

		    // format the url for a tweet (get rid of j parameter and create p (or pk) parameter)
		    // var uri = encodeURIComponent(UpdateQueryString("j",null, UpdateQueryString("p",feature.properties.PK)))
		    var uri = 'http://thejourney.aila.org.au/map?j='+feature.properties.PK
		    // var uri = 'http://thejourney.aila.org.au'

		    // Style Popup and create HTML
		    card = ' <div id="card-wrapper"><div class="popup-close noselect" onclick="getMarker('+feature.properties.PK+', true).closePopup();"><i class="material-icons noselect">close</i></div>'

		    +'<div class="card noselect" id="' + feature.properties.PK + '">' +
		        '<div class="card-image waves-effect waves-block waves-light">' +
		    // '<img class="activator" src="' + (feature.properties.photo ? feature.properties.photo : "img/landscape.jpg") + '"/>' +
		    '<img class="activator" src="img/photos/' + feature.properties.PK + '.jpg"/>' +
		        '</div>' +
		        '<div class="card-content">' +
		        '<span class="card-title grey-text text-darken-4 select">' +
		        '<i class="material-icons right dropdown-activator noselect" data-activates="dropdown1" onclick="openDropdown(this)">menu</i>' + feature.properties.project + '</span>' +
		        '<p class="select">' + ((feature.properties.url) ? '<a href="' + feature.properties.url + '" target="_blank"><i class="material-icons card-link-icon">link</i>' + feature.properties.designer +
		            '</a></p><ul id="dropdown1" class="dropdown z-depth-2">' : '<a href="http://www.google.com/search?q=' + encodeURIComponent(feature.properties.designer) + '%20site:au&btnI" target="_blank"><i class="material-icons card-link-icon">link</i>' + feature.properties.designer +
		            '</a></p><ul id="dropdown1" class="dropdown z-depth-2" >') +
		        '<li><a href="https://twitter.com/intent/tweet?url=' + uri + '&text=Check out ' + hashTag + ' @TheJourney — Interactive Landscape Tour Map' + '" onclick="window.open(this.href);return false;"><img src="img/twitter.svg" class="twitter-icon" /> Tweet location</a></li>' +
		        '<li class="addToJourney">' +
		        ((feature.properties.addedToJourney) ? '<span class="addToJourney" onclick="removeFromJourney(this,' + feature.properties.PK + ')"><i class="material-icons" style="color:red">remove</i> Remove this site</span>' : '<span class="addToJourney" onclick="addToJourney(this,' + feature.properties.PK + ')"><i class="material-icons green-text">add</i> Add to Journey</span>') + '</li>' + '<li><span class="activator"><i class="material-icons more-icon">more_horiz</i>Read more</span></li></ul>' +
		        '</div>' +
		        '<div class="card-reveal">' +
		        '<span class="card-title grey-text text-darken-4 select">' +
		        '<i class="material-icons right noselect">close</i>' + feature.properties.project + '</span>' + ((feature.properties.address) ? '<p class="address select">' + feature.properties.address + '</p>' : '') +
		        '<p class="project-description select">' + feature.properties.description + '</p></div></div></div>'

		    //it's been added to the journey layer
		    if (feature.properties.addedToJourney) {
		        layer.bindPopup(card);
		        // layer.options.zIndexOffset = -1;
		        // layer.options.clickable = false;
		        layer.setIcon(L.icon(icon)).addTo(journeyLayer)
		        featureLayer.removeLayer(layer)
		        journey.push(layer);
		        last_added = layer

		        
				updateURI() /// use this to start saving and loading route.	
		        

		        if (journey.length > 1) $('.journey-menu').show();

		        // it is the location person icon
		    } else if (feature.properties.person) {
	    		locationLayer.removeLayer(layer)
	    		// journey.push(layer);		
	    		var jindex = $.inArray(layer, journey)
	    		// console.log(jindex)
	    		// journey.splice(jindex, 1)
	    		// console.log(journey[0])
	        	layer.setIcon(L.icon(icon_person)).addTo(locationLayer)
	        	layer.bindPopup(content_person);
	        	journey.push(layer);
	        	// console.log(journey)
		    		

		        
		        // layer.openPopup();
		    }
		    // its a standard layer/marker/feature.
		    else {
		        layer.bindPopup(card);
		        featureLayer.removeLayer(layer)
		        layer.setIcon(L.icon(icon)).addTo(featureLayer)
		        layer.setOpacity(0)

		    };

		    // check if max waypoints reached
		    if (journey.length == maxWaypoints) {
		        Materialize.toast("Take a break! Or start another journey - 26 sites is the limit.", 6000)
		    }




		}


		function googleURL(){
			var url = "https://www.google.com/maps/dir/Current+Location";
			for (var i = 0; i < journey.length; i++) {
					url = url.concat("/"+journey[i].getLatLng().lat+','+journey[i].getLatLng().lng)
		        }
		    return url
		}

		function bounceMarkers() {
		 featureLayer.eachLayer(function(feature) {   
		        feature.setOpacity(1);
		        feature.bounce();
		    })
		}

		function openDropdown(e) {
		    $('.leaflet-popup-content .card').css("overflow", "visible")

		    if (journey.length == maxWaypoints) {

		        // featureLayer.eachLayer(function(marker) {
		        var markers = []
		        for (var i = 0; i < journey.length; i++) {
		            markers.push(journey[i].feature.properties.PK)
		        }
		        if (markers.indexOf(parseInt($(e).parents('.card').attr('id'))) == -1) {
		            $(e).parent().parent().find('li').first().html('<span class="addToJourney disabled tooltipped" style="color:#ddd"><i class="material-icons nav-icon" style="color:#ddd">navigation</i> Add to Journey</span>')
		            $(e).parent().parent().find('li').first().attr('data-tooltip', 'Take a break! Or start another journey - 26 sites is the limit.')
		            $(e).parent().parent().find('li').first().tooltip({
		                delay: 250,
		                position: 'top'
		            });
		        }


		    }
		    var activate = $(e).attr('data-activates')
		    $('#' + activate).toggle();

		}
		
		function createJourney(draw_route) {
		    if (journey.length == 1) {
		        destroyNav();
		        directions._unload();
		        // tell the user only 1 marker has been selected.
		    } else if (journey.length >= 2) {
		        directions._unload();
		        var journey_sorted = findClosest(journey, user_location);

		        directions.setOrigin(getMarker(journey_sorted[0]).getLatLng(), false)
		        directions.setDestination(getMarker(journey_sorted[1]).getLatLng(), false)
		        for (i = 2; i < journey_sorted.length; ++i) {
		            var waypoint = getMarker(journey_sorted[i], false).getLatLng();
		            directions.addWaypoint(i - 2, waypoint)
		        }
		        directions.query();
		        directions.on('load', function(e) {
		            nav_directions = e;
		            displayNav(e);
		        })
		    }
		    
		}

		function displayNav() {
			navDisplayed = true
			//update get google directions link
	    	$('#googledirections').attr('href', googleURL())
	    	$('#googledirections').show();
		    

		    route = nav_directions.routes[0]
		    steps = route.steps
		    rebuildSlider(0, steps.length)
		    var dur = duration(route.duration);
		    var dis = metric(route.distance);
		    $('#duration').html(dur)
		    $('#distance').html(dis)
		    $('.mapbox-marker-drag-icon-step').css('display', 'block');
		    $('.navigation-pane').css({
		        "display": "table",
		        "pointer-events":"all"
		    }).addClass("animated fadeInUp");
		};

		function destroyNav() {
			navDisplayed = false;
			$('#googledirections').hide();
		    $('.mapbox-marker-drag-icon-step').css('display', 'none');

		    $('.navigation-pane').css({
		        "display": "none",
		        "pointer-events":"none !important"
		    }).removeClass("animated fadeInUp");
		}

		function rebuildSlider(min, max) {
		    val = slider.noUiSlider.get();
		    slider.noUiSlider.destroy();
		    // Create a slider with the new options.
		    range_settings.range.min = min
		    range_settings.range.max = max - 1
		    // range_settings.limit = max - 1
		    // range_settings.start = start;
		    noUiSlider.create(slider, range_settings);
		    bindValue();
		}

		function bindValue() {
		    slider.noUiSlider.on('update', function(value, handle) {
		        // update something 
		        updateDirections(value)
		        // updateSliderValue.innerHTML = values[handle];
		    });
		}

		function getSiteNames() {
		    siteNames = []
		    for (var i = 0; i < nav_directions.routes[0].steps.length; i++) {
		        var type = nav_directions.routes[0].steps[i].maneuver.type;
		        if ((type == 'waypoint') || (type == 'arrive')) {
		            siteNames.push(i)
		        }
		    }
		    return siteNames
		}

		function updateDirections(value) {
		    if (nav_directions) {
		        // console.log(nav_directions)
		        
		        try {
		            var distance = metric(nav_directions.routes[0].steps[value].distance)
		        } catch (e) {
		            var distance = ''
		        }
		        var instruction = nav_directions.routes[0].steps[value].maneuver.instruction;
		        var type = nav_directions.routes[0].steps[value].maneuver.type
		        

		        instruction = $('<div>' + instruction + '</div>').text().split("/")[0].split("(")[0]

		        if ((type == 'waypoint')) {
		        	var siteNames = getSiteNames()
		        	var index = siteNames.indexOf(parseInt(value))
		            instruction = "You have reached your " + ordinalInWord(index + 1) + ' site.'
		        }

		        if ((type == 'arrive')) {
		            instruction = "You have visited your last site"
		        }

		        var heading = nav_directions.routes[0].steps[value].direction

		        var d = 'img/d-' + nav_directions.routes[0].steps[value].maneuver.type.replace(/\s+/g, '-').toLowerCase() + (((heading) && (value == 0)) ? '-' + heading : '') + '-icon.svg';

		        var latlng = L.latLng(nav_directions.routes[0].steps[value].maneuver.location.coordinates[1], nav_directions.routes[0].steps[value].maneuver.location.coordinates[0])

		        

			    map.setView(latlng, map.getZoom(), {
			        pan: {
			            animate: true,
			            duration: 1,
			            easeLinearity:0.25,
			            noMoveStart:true
			        },
			        zoom: {
			            animate: true
			        }
			    });
			
            

		        $('#maneuver').html(instruction)
		        $('#distance').html(distance)
		        $('.direction-icon').attr('src', d)
		        directions.highlightStep(nav_directions.routes[0].steps[value]);
		        // $('#direction').html()
		    }

		}

		function getMarker(pk, feature_layer) {
		    var got_marker;
		    if (feature_layer){	
			    featureLayer.eachLayer(function(marker) {
			        if (marker.feature.properties.PK == pk) {
			            got_marker = marker
			        }
			    })
			    return got_marker
		    }

		    journeyLayer.eachLayer(function(marker) {
		        if (marker.feature.properties.PK == pk) {
		            got_marker = marker
		        }
		    })
		    locationLayer.eachLayer(function(marker) {
		        if (marker.feature.properties.PK == pk) {
		            got_marker = marker
		        }
		    })
		    return got_marker
		};

		function addToJourney(e, pk) {

		    if (e) {
		        $(e).html('<i class="material-icons" style="color:green;">check</i> Added')
		    }

		    featureLayer.eachLayer(function(marker) {
		        if ((marker.feature.properties.PK == pk) && (marker !== last_added)) {
		            var m_geojson = marker.toGeoJSON();
		            m_geojson.properties.addedToJourney = true;
		            geojson.addData(m_geojson)
		            last_added = marker;
		            createJourney(true);
		        }
		    });
		}

		function readJourney(journey) {
		    if (journey) {
		        var route = journey.split(',');
		        featureLayer.eachLayer(function(marker) {
		            var pk = marker.feature.properties.PK
		            if (route.indexOf(String(pk)) !== -1) {
		                addToJourney('', pk)
		            }
		        })
		    }
		}

		function removeFromJourney(e, pk) {
		    $(e).html('<i class="material-icons nav-icon">navigation</i> Add to Journey')

		    journeyLayer.eachLayer(function(marker) {
		        if (marker.feature.properties.PK == pk) {
		            if (marker !== last_added) {}
		            journey.splice($.inArray(marker, journey), 1);
		            createJourney(true);
		            var m_geojson = marker.toGeoJSON();
		            journeyLayer.removeLayer(marker);
		            m_geojson.properties.addedToJourney = false;
		        }
		    })
		}

		function findClosest(journey, user_location) {
		    if (!user_location) {
		        user_location = journey[0].getLatLng(); // Ask the user for their location, or use the first marker selected.
		    }
		    var journey_sorted = []
		    for (i = 0; i < journey.length; ++i) {
		        journey_sorted[journey[i].feature.properties.PK] = distance(user_location.lat, user_location.lng, journey[i].getLatLng().lat, journey[i].getLatLng().lng)
		    }
		    journey_sorted = Object.keys(journey_sorted).sort(function(a, b) {
		        return journey_sorted[a] - journey_sorted[b]
		    });
		    return journey_sorted
		};



		 // add hover to Popup windows
		allLayers.eachLayer(function(layer) {
		    layer.on('mouseover', function(e) {
		        featureLayer.eachLayer(function(marker) {
		            // How to exclude journey markers from opacity change?
		            if (marker.feature.properties.WALK !== e.layer.feature.properties.WALK) {
		                marker.setOpacity(0.2);
		            }
		        });
		        journeyLayer.eachLayer(function(marker) {
		            // How to exclude journey markers from opacity change?
		            if (marker.feature.properties.WALK !== e.layer.feature.properties.WALK) {
		                marker.setOpacity(0.2);
		            }
		        });
		    });
		});


		allLayers.eachLayer(function(layer) {
		    layer.on('click', function(e) {
		        if (is_touch_device()) {
		            e.layer.openPopup();
		        }
		    });
		});

		allLayers.eachLayer(function(layer) {
		    layer.on('mouseout', function(e) {
		        featureLayer.eachLayer(function(marker) {
		            marker.setOpacity(1);
		        });
		        journeyLayer.eachLayer(function(marker) {
		            marker.setOpacity(1);
		        });
		    })
		});



		locationLayer.on('mouseover', function(e) {
		    e.layer.openPopup();
		}).on('click', function(e) {
		    if (is_touch_device()) e.layer.openPopup();
		});

		locationLayer.on('mouseout', function(e) {})

		 featureLayer.on('mouseover', function(e) {
		    e.layer.openPopup();
		})



		 // FILTER

		function filter(e) {

		    var searchString = $('#search').val().toLowerCase();
		    if (e) {
		        if (e.className == 'filter filtered') {
		            e.className = 'filter'
		        } else {
		            e.className = 'filter filtered'
		        }
		    }

		    var filters = []
		    var categories_filtered = document.getElementsByClassName('filtered')
		    var categories_all = document.getElementsByClassName('filter')

		    if (categories_filtered.length == 0) {
		        var categories = categories_all;
		    } else {
		        var categories = categories_filtered
		    }

		    for (var i = 0; i < categories.length; i++) {
		        filters.push(categories[i].dataset.walk);
		    }

		    featureLayer.eachLayer(function(marker) {
		        if (((marker.feature.properties.description + ' ' + marker.feature.properties.designer + ' ' + marker.feature.properties.address).toLowerCase().indexOf(searchString) !== -1) && marker.feature.properties.WALK && (filters.indexOf(marker.feature.properties.WALK) !== -1)) {

		            var icon = getIcon(marker);
		            marker.setIcon(L.icon(icon)).addTo(featureLayer)
		        } else {
		            marker.setIcon(L.icon({
		                "iconUrl": "img/b.svg",
		                "className": "hidden"
		            })).addTo(featureLayer)
		        }

		    })
		}

		function search() {


		    ($('#search').val() ? $('#close_search').css("display", 'inline') : $('#close_search').css("display", 'none'))

		    var filters = []
		    var list = document.getElementsByClassName('filtered')

		    // here we're simply comparing the various properties of each marker
		    // to the search string, seeing whether the former contains the latter.
		    for (var i = 0; i < list.length; i++) {
		        if (list[i].className == "filtered") filters.push(list[i].dataset.walk);
		    }
		    // get the value of the search input field
		    var searchString = $('#search').val().toLowerCase();
		    // featureLayer.setFilter(showState);
		    filter()

		    // if ((toast) && (esc == false) && $('#search').val().length > 0) {
		    //     Materialize.toast('Results by keyword', 3000, 'toast', function() {
		    //         toast = true;
		    //         esc = true;
		    //     });
		    //     toast = false;
		    // }
		}

		function clearFilters() {
		    $('#search').val('');
		    search();
		    $('#close_search').css('display', 'none');
		}

		 // FIND THE USER'S LOCATION

		 // if (!navigator.geolocation) {
		 //     geolocate.innerHTML = '<i class="material-icons">gps_off</i> Geolocation is not available <a href="#" id="geolocate" class="try-again" style="display:inline;">(try again)</a>';
		 // } else {
		 //     geolocate.onclick = function(e) {
		 //         e.preventDefault();
		 //         e.stopPropagation();

		 //     };
		 // }
		 // Once we've got a position, zoom and center the map
		 // on it, and add a single marker.
		map.on('locationfound', function(e) {
		    user_location = L.latLng(e.latlng.lat, e.latlng.lng)
		    map.fitBounds(e.bounds).setZoom(14);
		    geolocate.innerHTML = '<i class="material-icons">gps_fixed</i>' + ($(window).width() < 768 ? 'Found' : 'Found You ') + '<a href="#" id="geolocate" onclick="map.locate({watch:true,enableHighAccuracy:true, setView: true})" class="try-again" style="display:inline;">(update)</a>';
		    var l_geojson = {
		        type: "FeatureCollection",
		        features: [{
		            type: "Feature",
		            geometry: {
		                type: "Point",
		                coordinates: [e.latlng.lng, e.latlng.lat]
		            },
		            properties: {
		                person: true,
		                PK: 0
		            }
		        }]
		    }
		    geojson.addData(l_geojson)
		    // if (!navDisplayed) createJourney();
		    createJourney(false);
		    $('.button-collapse').sideNav('hide');

		});

		 // If the user chooses not to allow their location
		 // to be shared, display an error message.
		map.on('locationerror', function() {
		    geolocate.innerHTML = '<i class="material-icons">error</i>' + ($(window).width() < 768 ? 'No GPS' : 'Is your GPS enabled?') + '<a href="#" onclick="map.locate({watch:true,enableHighAccuracy:true, setView: true})" id="geolocate" class="try-again" style="display:inline; font-size:0.8em"> try again</a>';
		})






		 // UTILITY FUNCTIONS


		function UpdateQueryString(key, value, url) {

		    if (inIframe()) {
		        if (!url) url = window.location.href;
		    } else {
		        if (!url) url = window.location.href;
		    }

		    var re = new RegExp("([?&])" + key + "=.*?(&|#|$)(.*)", "gi"),
		        hash;

		    if (re.test(url)) {
		        if (typeof value !== 'undefined' && value !== null)
		            return url.replace(re, '$1' + key + "=" + value + '$2$3');
		        else {
		            hash = url.split('#');
		            url = hash[0].replace(re, '$1$3').replace(/(&|\?)$/, '');
		            if (typeof hash[1] !== 'undefined' && hash[1] !== null)
		                url += '#' + hash[1];
		            return url;
		        }
		    } else {
		        if (typeof value !== 'undefined' && value !== null) {
		            var separator = url.indexOf('?') !== -1 ? '&' : '?';
		            hash = url.split('#');
		            url = hash[0] + separator + key + '=' + value;
		            if (typeof hash[1] !== 'undefined' && hash[1] !== null)
		                url += '#' + hash[1];
		            return url;
		        } else
		            return url;
		    }
		}

		function duration(s) {
		    var m = Math.floor(s / 60),
		        h = Math.floor(m / 60);
		    s %= 60;
		    m %= 60;
		    if (h === 0 && m === 0) return s + ' s';
		    if (h === 0) return m + ' min';
		    return h + ' h ' + m + ' min';
		}

		function imperial(m) {
		    var mi = m / 1609.344;
		    if (mi >= 100) return mi.toFixed(0) + ' mi';
		    if (mi >= 10) return mi.toFixed(1) + ' mi';
		    if (mi >= 0.1) return mi.toFixed(2) + ' mi';
		    return (mi * 5280).toFixed(0) + ' ft';
		}

		function metric(m) {
		    if (m >= 100000) return (m / 1000).toFixed(0) + ' km';
		    if (m >= 10000) return (m / 1000).toFixed(1) + ' km';
		    if (m >= 100) return (m / 1000).toFixed(2) + ' km';
		    return m.toFixed(0) + ' m';
		}


		function getParameterByName(name) {
		    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		        results = regex.exec(location.search);
		    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		function is_touch_device() {
		    return 'ontouchstart' in window // works on most browsers 
		        || 'onmsgesturechange' in window; // works on ie10
		};

		function ordinalInWord(cardinal) {
		    var ordinals = ['zeroth', 'first', 'second', 'third' /* and so on up to "twentieth" */ ];
		    var tens = {
		        20: 'twenty',
		        30: 'thirty',
		        40: 'forty' /* and so on up to 90 */
		    };
		    var ordinalTens = {
		        30: 'thirtieth',
		        40: 'fortieth',
		        50: 'fiftieth' /* and so on */
		    };

		    if (cardinal <= 20) {
		        return ordinals[cardinal];
		    }

		    if (cardinal % 10 === 0) {
		        return ordinalTens[cardinal];
		    }

		    return tens[cardinal - (cardinal % 10)] + ordinals[cardinal % 10];
		}

		String.prototype.toProperCase = function() {
		    return this.replace(/\w\S*/g, function(txt) {
		        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
		    });
		};

		function updateURI() {
		    if (!inIframe()) {
		    	var bookmark = $.map(journey, function(obj) {
		        if (obj.feature.properties.PK !== 0) return obj.feature.properties.PK
			    	}).join(',');
			    uri = UpdateQueryString('j', bookmark)
			    var currentState = window.parent.history.state;
			    if (window.parent.history.replaceState) {
			        window.parent.history.replaceState(currentState, document.title, uri);
			    }
		    }
		    
		};

		function inIframe() {
		    try {
		        return window.self !== window.top;
		    } catch (e) {
		        return true;
		    }
		}

		function distance(lat1, lon1, lat2, lon2) {
		    var p = 0.017453292519943295; // Math.PI / 180
		    var c = Math.cos;
		    var a = 0.5 - c((lat2 - lat1) * p) / 2 +
		        c(lat1 * p) * c(lat2 * p) *
		        (1 - c((lon2 - lon1) * p)) / 2;

		    return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
		}

		(function($, Hammer, dataAttr) {
		    function hammerify(el, options) {
		        var $el = $(el);
		        if (!$el.data(dataAttr)) {
		            $el.data(dataAttr, new Hammer($el[0], options));
		        }
		    }

		    $.fn.hammer = function(options) {
		        return this.each(function() {
		            hammerify(this, options);
		        });
		    };

		    // extend the emit method to also trigger jQuery events
		    Hammer.Manager.prototype.emit = (function(originalEmit) {
		        return function(type, data) {
		            originalEmit.call(this, type, data);
		            jQuery(this.element).triggerHandler({
		                type: type,
		                gesture: data
		            });
		        };
		    })(Hammer.Manager.prototype.emit);
		})(jQuery, Hammer, "hammer");
		</script>
	</body>
</html>